name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # GLOBAL CACHE (boost speed)
      # ----------------------------------------------------
      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Cache electron + native modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
            ./node_modules/.cache
            ./node_modules/node-pty/build
            ./node_modules/keytar/build
            ./node_modules/ssh2/build
          key: ${{ runner.os }}-electron-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-electron-

      # ----------------------------------------------------
      # WINDOWS â€” install VS Build Tools
      # ----------------------------------------------------
      - name: Install VS Build Tools
        if: matrix.os == 'windows-latest'
        run: |
          choco install visualstudio2022buildtools --package-parameters `
            "--add Microsoft.VisualStudio.Workload.VCTools `
            --add Microsoft.VisualStudio.Component.Windows11SDK.22621 `
            --add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 `
            --includeRecommended --quiet --norestart"
        shell: powershell

      - name: Verify MSVC
        if: matrix.os == 'windows-latest'
        run: |
          echo "VC Tools:"
          dir "C:\Program Files\Microsoft Visual Studio\2022\BuildTools\VC\Tools"
        shell: powershell

      # ----------------------------------------------------
      # LINUX build deps
      # ----------------------------------------------------
      - name: Install Linux deps
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt update -y
          sudo apt install -y rpm libsecret-1-dev dpkg fakeroot

      # ----------------------------------------------------
      # Install deps (super fast with cache)
      # ----------------------------------------------------
      - name: Install dependencies
        run: npm ci

      - name: Build renderer
        run: npm run build:renderer

      - name: Build electron
        run: npm run build:electron

      # ----------------------------------------------------
      # Build by platform
      # ----------------------------------------------------
      - name: Build Windows
        if: matrix.os == 'windows-latest'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run build:win

      - name: Build Linux
        if: matrix.os == 'ubuntu-latest'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run build:linux

      - name: Build macOS
        if: matrix.os == 'macos-latest'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run build:mac

      # ----------------------------------------------------
      # Upload artifacts
      # ----------------------------------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}
          path: release/*

  # --------------------------------------------------------
  # RELEASE STEP
  # --------------------------------------------------------
  release:
    needs: build
    runs-on: ubuntu-latest

    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
